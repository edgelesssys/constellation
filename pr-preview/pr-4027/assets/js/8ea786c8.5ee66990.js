"use strict";(globalThis.webpackChunkconstellation_docs=globalThis.webpackChunkconstellation_docs||[]).push([[9509],{28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>o});var r=n(96540);const a={},i=r.createContext(a);function s(e){const t=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(i.Provider,{value:t},e.children)}},76832:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"architecture/keys","title":"Key management and cryptographic primitives","description":"Constellation protects and isolates your cluster and workloads.","source":"@site/versioned_docs/version-2.23/architecture/keys.md","sourceDirName":"architecture","slug":"/architecture/keys","permalink":"/constellation/2.23/architecture/keys","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/constellation/edit/main/docs/versioned_docs/version-2.23/architecture/keys.md","tags":[],"version":"2.23","frontMatter":{},"sidebar":"docs","previous":{"title":"Images","permalink":"/constellation/2.23/architecture/images"},"next":{"title":"Encrypted persistent storage","permalink":"/constellation/2.23/architecture/encrypted-storage"}}');var a=n(74848),i=n(28453);const s={},o="Key management and cryptographic primitives",l={},c=[{value:"Confidential VMs",id:"confidential-vms",level:2},{value:"Master secret",id:"master-secret",level:2},{value:"Cluster identity",id:"cluster-identity",level:2},{value:"Network encryption",id:"network-encryption",level:2},{value:"Storage encryption",id:"storage-encryption",level:2},{value:"Constellation-managed key management",id:"constellation-managed-key-management",level:3},{value:"Key material and key derivation",id:"key-material-and-key-derivation",level:4},{value:"State and storage",id:"state-and-storage",level:4},{value:"Availability",id:"availability",level:4},{value:"Recovery",id:"recovery",level:4},{value:"User-managed key management",id:"user-managed-key-management",level:3},{value:"Recovery and migration",id:"recovery-and-migration",level:4}];function d(e){const t={a:"a",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.header,{children:(0,a.jsx)(t.h1,{id:"key-management-and-cryptographic-primitives",children:"Key management and cryptographic primitives"})}),"\n",(0,a.jsx)(t.p,{children:"Constellation protects and isolates your cluster and workloads.\nTo that end, cryptography is the foundation that ensures the confidentiality and integrity of all components.\nEvaluating the security and compliance of Constellation requires a precise understanding of the cryptographic primitives and keys used.\nThe following gives an overview of the architecture and explains the technical details."}),"\n",(0,a.jsx)(t.h2,{id:"confidential-vms",children:"Confidential VMs"}),"\n",(0,a.jsx)(t.p,{children:"Confidential VM (CVM) technology comes with hardware and software components for memory encryption, isolation, and remote attestation.\nFor details on the implementations and cryptographic soundness, refer to the hardware vendors' documentation and advisories."}),"\n",(0,a.jsx)(t.h2,{id:"master-secret",children:"Master secret"}),"\n",(0,a.jsxs)(t.p,{children:["The master secret is the cryptographic material used for deriving the ",(0,a.jsx)(t.a,{href:"#cluster-identity",children:(0,a.jsx)(t.em,{children:"clusterID"})})," and the ",(0,a.jsx)(t.em,{children:"key encryption key (KEK)"})," for ",(0,a.jsx)(t.a,{href:"#storage-encryption",children:"storage encryption"}),".\nIt's generated during the bootstrapping of a Constellation cluster.\nIt can either be managed by ",(0,a.jsx)(t.a,{href:"#constellation-managed-key-management",children:"Constellation"})," or an ",(0,a.jsx)(t.a,{href:"#user-managed-key-management",children:"external key management system"}),".\nIn case of ",(0,a.jsx)(t.a,{href:"#recovery-and-migration",children:"recovery"}),", the master secret allows to decrypt the state and recover a Constellation cluster."]}),"\n",(0,a.jsx)(t.h2,{id:"cluster-identity",children:"Cluster identity"}),"\n",(0,a.jsxs)(t.p,{children:["The identity of a Constellation cluster is represented by cryptographic ",(0,a.jsx)(t.a,{href:"/constellation/2.23/architecture/attestation#runtime-measurements",children:"measurements"}),":"]}),"\n",(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.strong,{children:"base measurements"})," represent the identity of a valid, uninitialized Constellation node.\nThey depend on the node image, but are otherwise the same for every Constellation cluster.\nOn node boot, they're determined using the CVM's attestation mechanism and ",(0,a.jsx)(t.a,{href:"/constellation/2.23/architecture/images",children:"measured boot up to the read-only root filesystem"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.strong,{children:"clusterID"})," represents the identity of a single initialized Constellation cluster.\nIt's derived from the master secret and a cryptographically random salt and unique for every Constellation cluster.\nThe ",(0,a.jsx)(t.a,{href:"/constellation/2.23/architecture/microservices#bootstrapper",children:"Bootstrapper"})," measures the ",(0,a.jsx)(t.em,{children:"clusterID"})," into its own PCR before executing any code not measured as part of the ",(0,a.jsx)(t.em,{children:"base measurements"}),".\nSee ",(0,a.jsx)(t.a,{href:"/constellation/2.23/architecture/attestation#node-attestation",children:"Node attestation"})," for details."]}),"\n",(0,a.jsxs)(t.p,{children:["The remote attestation statement of a Constellation cluster combines the ",(0,a.jsx)(t.em,{children:"base measurements"})," and the ",(0,a.jsx)(t.em,{children:"clusterID"})," for a verifiable, unspoofable, unique identity."]}),"\n",(0,a.jsx)(t.h2,{id:"network-encryption",children:"Network encryption"}),"\n",(0,a.jsxs)(t.p,{children:["Constellation encrypts all cluster network communication using the ",(0,a.jsx)(t.a,{href:"https://github.com/containernetworking/cni",children:"container network interface (CNI)"}),".\nSee ",(0,a.jsx)(t.a,{href:"/constellation/2.23/architecture/networking",children:"network encryption"})," for more details."]}),"\n",(0,a.jsxs)(t.p,{children:["The Cilium agent running on each node establishes a secure ",(0,a.jsx)(t.a,{href:"https://www.wireguard.com/",children:"WireGuard"})," tunnel between it and all other known nodes in the cluster.\nEach node creates its own ",(0,a.jsx)(t.a,{href:"http://cr.yp.to/ecdh.html",children:"Curve25519"})," encryption key pair and distributes its public key via Kubernetes.\nA node uses another node's public key to decrypt and encrypt traffic from and to Cilium-managed endpoints running on that node.\nConnections are always encrypted peer-to-peer using ",(0,a.jsx)(t.a,{href:"http://cr.yp.to/chacha.html",children:"ChaCha20"})," with ",(0,a.jsx)(t.a,{href:"http://cr.yp.to/mac.html",children:"Poly1305"}),".\nWireGuard implements ",(0,a.jsx)(t.a,{href:"https://lists.zx2c4.com/pipermail/wireguard/2017-December/002141.html",children:"forward secrecy with key rotation every 2 minutes"}),"."]}),"\n",(0,a.jsx)(t.h2,{id:"storage-encryption",children:"Storage encryption"}),"\n",(0,a.jsx)(t.p,{children:"Constellation supports transparent encryption of persistent storage.\nThe Linux kernel's device mapper-based encryption features are used to encrypt the data on the block storage level.\nCurrently, the following primitives are used for block storage encryption:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/dm-crypt.html",children:"dm-crypt"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/dm-integrity.html",children:"dm-integrity"})}),"\n"]}),"\n",(0,a.jsxs)(t.p,{children:["Adding primitives for integrity protection in the CVM attacker model are under active development and will be available in a future version of Constellation.\nSee ",(0,a.jsx)(t.a,{href:"/constellation/2.23/architecture/encrypted-storage",children:"encrypted storage"})," for more details."]}),"\n",(0,a.jsxs)(t.p,{children:["As a cluster administrator, when creating a cluster, you can use the Constellation ",(0,a.jsx)(t.a,{href:"/constellation/2.23/architecture/orchestration",children:"installation program"})," to select one of the following methods for key management:"]}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Constellation-managed key management"}),"\n",(0,a.jsx)(t.li,{children:"User-managed key management"}),"\n"]}),"\n",(0,a.jsx)(t.h3,{id:"constellation-managed-key-management",children:"Constellation-managed key management"}),"\n",(0,a.jsx)(t.h4,{id:"key-material-and-key-derivation",children:"Key material and key derivation"}),"\n",(0,a.jsxs)(t.p,{children:["During the creation of a Constellation cluster, the cluster's master secret is used to derive a KEK.\nThis means creating two clusters with the same master secret will yield the same KEK.\nAny data encryption key (DEK) is derived from the KEK via HKDF.\nNote that the master secret is recommended to be unique for every cluster and shouldn't be reused (except in case of ",(0,a.jsx)(t.a,{href:"/constellation/2.23/workflows/recovery",children:"recovering"})," a cluster)."]}),"\n",(0,a.jsx)(t.h4,{id:"state-and-storage",children:"State and storage"}),"\n",(0,a.jsx)(t.p,{children:"The KEK is derived from the master secret during the initialization.\nSubsequently, all other key material is derived from the KEK.\nGiven the same KEK, any DEK can be derived deterministically from a given identifier.\nHence, there is no need to store DEKs. They can be derived on demand.\nAfter the KEK was derived, it's stored in memory only and never leaves the CVM context."}),"\n",(0,a.jsx)(t.h4,{id:"availability",children:"Availability"}),"\n",(0,a.jsxs)(t.p,{children:["Constellation-managed key management has the same availability as the underlying Kubernetes cluster.\nTherefore, the KEK is stored in the ",(0,a.jsx)(t.a,{href:"https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/",children:"distributed Kubernetes etcd storage"})," to allow for unexpected but non-fatal (control-plane) node failure.\nThe etcd storage is backed by the encrypted and integrity protected ",(0,a.jsx)(t.a,{href:"/constellation/2.23/architecture/images#state-disk",children:"state disk"})," of the nodes."]}),"\n",(0,a.jsx)(t.h4,{id:"recovery",children:"Recovery"}),"\n",(0,a.jsxs)(t.p,{children:["Constellation clusters can be recovered in the event of a disaster, even when all node machines have been stopped and need to be rebooted.\nFor details on the process see the ",(0,a.jsx)(t.a,{href:"/constellation/2.23/workflows/recovery",children:"recovery workflow"}),"."]}),"\n",(0,a.jsx)(t.h3,{id:"user-managed-key-management",children:"User-managed key management"}),"\n",(0,a.jsx)(t.p,{children:"User-managed key management is under active development and will be available soon.\nIn scenarios where constellation-managed key management isn't an option, this mode allows you to keep full control of your keys.\nFor example, compliance requirements may force you to keep your KEKs in an on-prem key management system (KMS)."}),"\n",(0,a.jsx)(t.p,{children:'During the creation of a Constellation cluster, you specify a KEK present in a remote KMS.\nThis follows the common scheme of "bring your own key" (BYOK).\nConstellation will support several KMSs for managing the storage and access of your KEK.\nInitially, it will support the following KMSs:'}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://aws.amazon.com/kms/",children:"AWS KMS"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://cloud.google.com/security-key-management",children:"GCP KMS"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://azure.microsoft.com/en-us/services/key-vault/#product-overview",children:"Azure Key Vault"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=kmip",children:"KMIP-compatible KMS"})}),"\n"]}),"\n",(0,a.jsx)(t.p,{children:"Storing the keys in Cloud KMS of AWS, Azure, or GCP binds the key usage to the particular cloud identity access management (IAM).\nIn the future, Constellation will support remote attestation-based access policies for Cloud KMS once available.\nNote that using a Cloud KMS limits the isolation and protection to the guarantees of the particular offering."}),"\n",(0,a.jsx)(t.p,{children:'KMIP support allows you to use your KMIP-compatible on-prem KMS and keep full control over your keys.\nThis follows the common scheme of "hold your own key" (HYOK).'}),"\n",(0,a.jsx)(t.p,{children:'The KEK is used to encrypt per-data "data encryption keys" (DEKs).\nDEKs are generated to encrypt your data before storing it on persistent storage.\nAfter being encrypted by the KEK, the DEKs are stored on dedicated cloud storage for persistence.\nCurrently, Constellation supports the following cloud storage options:'}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://aws.amazon.com/s3/",children:"AWS S3"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://cloud.google.com/storage",children:"GCP Cloud Storage"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://azure.microsoft.com/en-us/services/storage/blobs/#overview",children:"Azure Blob Storage"})}),"\n"]}),"\n",(0,a.jsx)(t.p,{children:"The DEKs are only present in plaintext form in the encrypted main memory of the CVMs.\nSimilarly, the cryptographic operations for encrypting data before writing it to persistent storage are performed in the context of the CVMs."}),"\n",(0,a.jsx)(t.h4,{id:"recovery-and-migration",children:"Recovery and migration"}),"\n",(0,a.jsx)(t.p,{children:"In the case of a disaster, the KEK can be used to decrypt the DEKs locally and subsequently use them to decrypt and retrieve the data.\nIn case of migration, configuring the same KEK will provide seamless migration of data.\nThus, only the DEK storage needs to be transferred to the new cluster alongside the encrypted data for seamless migration."})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}}}]);