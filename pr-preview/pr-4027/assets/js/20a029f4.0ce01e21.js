"use strict";(globalThis.webpackChunkconstellation_docs=globalThis.webpackChunkconstellation_docs||[]).push([[5343],{28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>s});var t=r(96540);const o={},l=t.createContext(o);function i(e){const n=t.useContext(l);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),t.createElement(l.Provider,{value:n},e.children)}},57710:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/recovery-gcp-serial-console-link-d31487c5a5e88fbcde9dcc33e876838d.png"},80438:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"workflows/recovery","title":"Recover your cluster","description":"Recovery of a Constellation cluster means getting it back into a healthy state after too many concurrent node failures in the control plane.","source":"@site/versioned_docs/version-2.22/workflows/recovery.md","sourceDirName":"workflows","slug":"/workflows/recovery","permalink":"/constellation/2.22/workflows/recovery","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/constellation/edit/main/docs/versioned_docs/version-2.22/workflows/recovery.md","tags":[],"version":"2.22","frontMatter":{},"sidebar":"docs","previous":{"title":"Terminate your cluster","permalink":"/constellation/2.22/workflows/terminate"},"next":{"title":"Verify your cluster","permalink":"/constellation/2.22/workflows/verify-cluster"}}');var o=r(74848),l=r(28453);const i={},s="Recover your cluster",c={},a=[{value:"Identify unhealthy clusters",id:"identify-unhealthy-clusters",level:2},{value:"Recover a cluster",id:"recover-a-cluster",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components},{TabItem:t,Tabs:i}=n;return t||g("TabItem",!0),i||g("Tabs",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"recover-your-cluster",children:"Recover your cluster"})}),"\n",(0,o.jsxs)(n.p,{children:["Recovery of a Constellation cluster means getting it back into a healthy state after too many concurrent node failures in the control plane.\nReasons for an unhealthy cluster can vary from a power outage, or planned reboot, to migration of nodes and regions.\nRecovery events are rare, because Constellation is built for high availability and automatically and securely replaces failed nodes. When a node is replaced, Constellation's control plane first verifies the new node before it sends the node the cryptographic keys required to decrypt its ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/images#state-disk",children:"state disk"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["Constellation provides a recovery mechanism for cases where the control plane has failed and is unable to replace nodes.\nThe ",(0,o.jsx)(n.code,{children:"constellation recover"})," command securely connects to all nodes in need of recovery using ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/attestation#attested-tls-atls",children:"attested TLS"})," and provides them with the keys to decrypt their state disks and continue booting."]}),"\n",(0,o.jsx)(n.h2,{id:"identify-unhealthy-clusters",children:"Identify unhealthy clusters"}),"\n",(0,o.jsx)(n.p,{children:"The first step to recovery is identifying when a cluster becomes unhealthy.\nUsually, this can be first observed when the Kubernetes API server becomes unresponsive."}),"\n",(0,o.jsx)(n.p,{children:"You can check the health status of the nodes via the cloud service provider (CSP).\nConstellation provides logging information on the boot process and status via serial console output.\nIn the following, you'll find detailed descriptions for identifying clusters stuck in recovery for each CSP."}),"\n",(0,o.jsxs)(i,{groupId:"csp",children:[(0,o.jsxs)(t,{value:"aws",label:"AWS",children:[(0,o.jsxs)(n.p,{children:["First, open the AWS console to view all Auto Scaling Groups (ASGs) in the region of your cluster. Select the ASG of the control plane ",(0,o.jsx)(n.code,{children:"<cluster-name>-<UID>-control-plane"})," and check that enough members are in a ",(0,o.jsx)(n.em,{children:"Running"})," state."]}),(0,o.jsxs)(n.p,{children:["Second, check the boot logs of these ",(0,o.jsx)(n.em,{children:"Instances"}),". In the ASG's ",(0,o.jsx)(n.em,{children:"Instance management"})," view, select each desired instance. In the upper right corner, select ",(0,o.jsx)(n.strong,{children:"Action > Monitor and troubleshoot > Get system log"}),"."]}),(0,o.jsxs)(n.p,{children:["In the serial console output, search for ",(0,o.jsx)(n.code,{children:"Waiting for decryption key"}),".\nSimilar output to the following means your node was restarted and needs to decrypt the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/images#state-disk",children:"state disk"}),":"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{"level":"INFO","ts":"2022-09-08T10:21:53Z","caller":"cmd/main.go:55","msg":"Starting disk-mapper","version":"2.0.0","cloudProvider":"gcp"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"setupManager","caller":"setup/setup.go:72","msg":"Preparing existing state disk"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:65","msg":"Starting RejoinClient"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"recoveryServer","caller":"recoveryserver/server.go:59","msg":"Starting RecoveryServer"}\n'})}),(0,o.jsxs)(n.p,{children:["The node will then try to connect to the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/microservices#joinservice",children:(0,o.jsx)(n.em,{children:"JoinService"})})," and obtain the decryption key.\nIf this fails due to an unhealthy control plane, you will see log messages similar to the following:"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:77","msg":"Received list with JoinService endpoints","endpoints":["192.168.178.4:30090","192.168.178.2:30090"]}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:96","msg":"Requesting rejoin ticket","endpoint":"192.168.178.4:30090"}\n{"level":"WARN","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:101","msg":"Failed to rejoin on endpoint","error":"rpc error: code = Unavailable desc = connection error: desc = \\"transport: Error while dialing dial tcp 192.168.178.4:30090: connect: connection refused\\"","endpoint":"192.168.178.4:30090"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:96","msg":"Requesting rejoin ticket","endpoint":"192.168.178.2:30090"}\n{"level":"WARN","ts":"2022-09-08T10:22:13Z","logger":"rejoinClient","caller":"rejoinclient/client.go:101","msg":"Failed to rejoin on endpoint","error":"rpc error: code = Unavailable desc = connection error: desc = \\"transport: Error while dialing dial tcp 192.168.178.2:30090: i/o timeout\\"","endpoint":"192.168.178.2:30090"}\n{"level":"ERROR","ts":"2022-09-08T10:22:13Z","logger":"rejoinClient","caller":"rejoinclient/client.go:110","msg":"Failed to rejoin on all endpoints"}\n'})}),(0,o.jsx)(n.p,{children:"This means that you have to recover the node manually."})]}),(0,o.jsxs)(t,{value:"azure",label:"Azure",children:[(0,o.jsxs)(n.p,{children:["In the Azure portal, find the cluster's resource group.\nInside the resource group, open the control plane ",(0,o.jsx)(n.em,{children:"Virtual machine scale set"})," ",(0,o.jsx)(n.code,{children:"constellation-scale-set-controlplanes-<suffix>"}),".\nOn the left, go to ",(0,o.jsx)(n.strong,{children:"Settings"})," > ",(0,o.jsx)(n.strong,{children:"Instances"})," and check that enough members are in a ",(0,o.jsx)(n.em,{children:"Running"})," state."]}),(0,o.jsxs)(n.p,{children:["Second, check the boot logs of these ",(0,o.jsx)(n.em,{children:"Instances"}),".\nIn the scale set's ",(0,o.jsx)(n.em,{children:"Instances"})," view, open the details page of the desired instance.\nOn the left, go to ",(0,o.jsx)(n.strong,{children:"Support + troubleshooting"})," > ",(0,o.jsx)(n.strong,{children:"Serial console"}),"."]}),(0,o.jsxs)(n.p,{children:["In the serial console output, search for ",(0,o.jsx)(n.code,{children:"Waiting for decryption key"}),".\nSimilar output to the following means your node was restarted and needs to decrypt the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/images#state-disk",children:"state disk"}),":"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{"level":"INFO","ts":"2022-09-08T09:56:41Z","caller":"cmd/main.go:55","msg":"Starting disk-mapper","version":"2.0.0","cloudProvider":"azure"}\n{"level":"INFO","ts":"2022-09-08T09:56:43Z","logger":"setupManager","caller":"setup/setup.go:72","msg":"Preparing existing state disk"}\n{"level":"INFO","ts":"2022-09-08T09:56:43Z","logger":"recoveryServer","caller":"recoveryserver/server.go:59","msg":"Starting RecoveryServer"}\n{"level":"INFO","ts":"2022-09-08T09:56:43Z","logger":"rejoinClient","caller":"rejoinclient/client.go:65","msg":"Starting RejoinClient"}\n'})}),(0,o.jsxs)(n.p,{children:["The node will then try to connect to the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/microservices#joinservice",children:(0,o.jsx)(n.em,{children:"JoinService"})})," and obtain the decryption key.\nIf this fails due to an unhealthy control plane, you will see log messages similar to the following:"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{"level":"INFO","ts":"2022-09-08T09:56:43Z","logger":"rejoinClient","caller":"rejoinclient/client.go:77","msg":"Received list with JoinService endpoints","endpoints":["10.9.0.5:30090","10.9.0.6:30090"]}\n{"level":"INFO","ts":"2022-09-08T09:56:43Z","logger":"rejoinClient","caller":"rejoinclient/client.go:96","msg":"Requesting rejoin ticket","endpoint":"10.9.0.5:30090"}\n{"level":"WARN","ts":"2022-09-08T09:57:03Z","logger":"rejoinClient","caller":"rejoinclient/client.go:101","msg":"Failed to rejoin on endpoint","error":"rpc error: code = Unavailable desc = connection error: desc = \\"transport: Error while dialing dial tcp 10.9.0.5:30090: i/o timeout\\"","endpoint":"10.9.0.5:30090"}\n{"level":"INFO","ts":"2022-09-08T09:57:03Z","logger":"rejoinClient","caller":"rejoinclient/client.go:96","msg":"Requesting rejoin ticket","endpoint":"10.9.0.6:30090"}\n{"level":"WARN","ts":"2022-09-08T09:57:23Z","logger":"rejoinClient","caller":"rejoinclient/client.go:101","msg":"Failed to rejoin on endpoint","error":"rpc error: code = Unavailable desc = connection error: desc = \\"transport: Error while dialing dial tcp 10.9.0.6:30090: i/o timeout\\"","endpoint":"10.9.0.6:30090"}\n{"level":"ERROR","ts":"2022-09-08T09:57:23Z","logger":"rejoinClient","caller":"rejoinclient/client.go:110","msg":"Failed to rejoin on all endpoints"}\n'})}),(0,o.jsx)(n.p,{children:"This means that you have to recover the node manually."})]}),(0,o.jsxs)(t,{value:"gcp",label:"GCP",children:[(0,o.jsxs)(n.p,{children:["First, check that the control plane ",(0,o.jsx)(n.em,{children:"Instance Group"})," has enough members in a ",(0,o.jsx)(n.em,{children:"Ready"})," state.\nIn the GCP Console, go to ",(0,o.jsx)(n.strong,{children:"Instance Groups"})," and check the group for the cluster's control plane ",(0,o.jsx)(n.code,{children:"<cluster-name>-control-plane-<suffix>"}),"."]}),(0,o.jsxs)(n.p,{children:["Second, check the status of the ",(0,o.jsx)(n.em,{children:"VM Instances"}),".\nGo to ",(0,o.jsx)(n.strong,{children:"VM Instances"})," and open the details of the desired instance.\nCheck the serial console output of that instance by opening the ",(0,o.jsx)(n.strong,{children:"Logs"})," > ",(0,o.jsx)(n.strong,{children:"Serial port 1 (console)"})," page:"]}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"GCP portal serial console link",src:r(57710).A+"",width:"846",height:"415"})}),(0,o.jsxs)(n.p,{children:["In the serial console output, search for ",(0,o.jsx)(n.code,{children:"Waiting for decryption key"}),".\nSimilar output to the following means your node was restarted and needs to decrypt the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/images#state-disk",children:"state disk"}),":"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{"level":"INFO","ts":"2022-09-08T10:21:53Z","caller":"cmd/main.go:55","msg":"Starting disk-mapper","version":"2.0.0","cloudProvider":"gcp"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"setupManager","caller":"setup/setup.go:72","msg":"Preparing existing state disk"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:65","msg":"Starting RejoinClient"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"recoveryServer","caller":"recoveryserver/server.go:59","msg":"Starting RecoveryServer"}\n'})}),(0,o.jsxs)(n.p,{children:["The node will then try to connect to the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/microservices#joinservice",children:(0,o.jsx)(n.em,{children:"JoinService"})})," and obtain the decryption key.\nIf this fails due to an unhealthy control plane, you will see log messages similar to the following:"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:77","msg":"Received list with JoinService endpoints","endpoints":["192.168.178.4:30090","192.168.178.2:30090"]}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:96","msg":"Requesting rejoin ticket","endpoint":"192.168.178.4:30090"}\n{"level":"WARN","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:101","msg":"Failed to rejoin on endpoint","error":"rpc error: code = Unavailable desc = connection error: desc = \\"transport: Error while dialing dial tcp 192.168.178.4:30090: connect: connection refused\\"","endpoint":"192.168.178.4:30090"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:96","msg":"Requesting rejoin ticket","endpoint":"192.168.178.2:30090"}\n{"level":"WARN","ts":"2022-09-08T10:22:13Z","logger":"rejoinClient","caller":"rejoinclient/client.go:101","msg":"Failed to rejoin on endpoint","error":"rpc error: code = Unavailable desc = connection error: desc = \\"transport: Error while dialing dial tcp 192.168.178.2:30090: i/o timeout\\"","endpoint":"192.168.178.2:30090"}\n{"level":"ERROR","ts":"2022-09-08T10:22:13Z","logger":"rejoinClient","caller":"rejoinclient/client.go:110","msg":"Failed to rejoin on all endpoints"}\n'})}),(0,o.jsx)(n.p,{children:"This means that you have to recover the node manually."})]}),(0,o.jsxs)(t,{value:"stackit",label:"STACKIT",children:[(0,o.jsxs)(n.p,{children:["First, open the STACKIT portal to view all servers in your project. Select individual control plane nodes ",(0,o.jsx)(n.code,{children:"<cluster-name>-<UID>-control-plane-<UID>-<index>"})," and check that enough members are in a ",(0,o.jsx)(n.em,{children:"Running"})," state."]}),(0,o.jsxs)(n.p,{children:["Second, check the boot logs of these servers. Click on a server name and select ",(0,o.jsx)(n.strong,{children:"Overview"}),". Find the ",(0,o.jsx)(n.strong,{children:"Machine Setup"})," section and click on ",(0,o.jsx)(n.strong,{children:"Web console"})," > ",(0,o.jsx)(n.strong,{children:"Open console"}),"."]}),(0,o.jsxs)(n.p,{children:["In the serial console output, search for ",(0,o.jsx)(n.code,{children:"Waiting for decryption key"}),".\nSimilar output to the following means your node was restarted and needs to decrypt the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/images#state-disk",children:"state disk"}),":"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{"level":"INFO","ts":"2022-09-08T10:21:53Z","caller":"cmd/main.go:55","msg":"Starting disk-mapper","version":"2.0.0","cloudProvider":"gcp"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"setupManager","caller":"setup/setup.go:72","msg":"Preparing existing state disk"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:65","msg":"Starting RejoinClient"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"recoveryServer","caller":"recoveryserver/server.go:59","msg":"Starting RecoveryServer"}\n'})}),(0,o.jsxs)(n.p,{children:["The node will then try to connect to the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/microservices#joinservice",children:(0,o.jsx)(n.em,{children:"JoinService"})})," and obtain the decryption key.\nIf this fails due to an unhealthy control plane, you will see log messages similar to the following:"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:77","msg":"Received list with JoinService endpoints","endpoints":["192.168.178.4:30090","192.168.178.2:30090"]}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:96","msg":"Requesting rejoin ticket","endpoint":"192.168.178.4:30090"}\n{"level":"WARN","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:101","msg":"Failed to rejoin on endpoint","error":"rpc error: code = Unavailable desc = connection error: desc = \\"transport: Error while dialing dial tcp 192.168.178.4:30090: connect: connection refused\\"","endpoint":"192.168.178.4:30090"}\n{"level":"INFO","ts":"2022-09-08T10:21:53Z","logger":"rejoinClient","caller":"rejoinclient/client.go:96","msg":"Requesting rejoin ticket","endpoint":"192.168.178.2:30090"}\n{"level":"WARN","ts":"2022-09-08T10:22:13Z","logger":"rejoinClient","caller":"rejoinclient/client.go:101","msg":"Failed to rejoin on endpoint","error":"rpc error: code = Unavailable desc = connection error: desc = \\"transport: Error while dialing dial tcp 192.168.178.2:30090: i/o timeout\\"","endpoint":"192.168.178.2:30090"}\n{"level":"ERROR","ts":"2022-09-08T10:22:13Z","logger":"rejoinClient","caller":"rejoinclient/client.go:110","msg":"Failed to rejoin on all endpoints"}\n'})}),(0,o.jsx)(n.p,{children:"This means that you have to recover the node manually."})]})]}),"\n",(0,o.jsx)(n.h2,{id:"recover-a-cluster",children:"Recover a cluster"}),"\n",(0,o.jsx)(n.p,{children:"Recovering a cluster requires the following parameters:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["The ",(0,o.jsx)(n.code,{children:"constellation-state.yaml"})," file in your working directory or the cluster's endpoint"]}),"\n",(0,o.jsx)(n.li,{children:"The master secret of the cluster"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"A cluster can be recovered like this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ constellation recover\nPushed recovery key.\nPushed recovery key.\nPushed recovery key.\nRecovered 3 control-plane nodes.\n"})}),"\n",(0,o.jsx)(n.p,{children:"In the serial console output of the node you'll see a similar output to the following:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{"level":"INFO","ts":"2022-09-08T10:26:59Z","logger":"recoveryServer","caller":"recoveryserver/server.go:93","msg":"Received recover call"}\n{"level":"INFO","ts":"2022-09-08T10:26:59Z","logger":"recoveryServer","caller":"recoveryserver/server.go:125","msg":"Received state disk key and measurement secret, shutting down server"}\n{"level":"INFO","ts":"2022-09-08T10:26:59Z","logger":"recoveryServer.gRPC","caller":"zap/server_interceptors.go:61","msg":"finished streaming call with code OK","grpc.start_time":"2022-09-08T10:26:59Z","system":"grpc","span.kind":"server","grpc.service":"recoverproto.API","grpc.method":"Recover","peer.address":"192.0.2.3:41752","grpc.code":"OK","grpc.time_ms":15.701}\n{"level":"INFO","ts":"2022-09-08T10:27:13Z","logger":"rejoinClient","caller":"rejoinclient/client.go:87","msg":"RejoinClient stopped"}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}function g(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);