"use strict";(globalThis.webpackChunkconstellation_docs=globalThis.webpackChunkconstellation_docs||[]).push([[8748],{24258:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>n,toc:()=>i});const n=JSON.parse('{"id":"getting-started/examples/filestash-s3proxy","title":"Deploying Filestash","description":"Filestash is a web frontend for different storage backends, including S3.","source":"@site/versioned_docs/version-2.24/getting-started/examples/filestash-s3proxy.md","sourceDirName":"getting-started/examples","slug":"/getting-started/examples/filestash-s3proxy","permalink":"/constellation/getting-started/examples/filestash-s3proxy","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/constellation/edit/main/docs/versioned_docs/version-2.24/getting-started/examples/filestash-s3proxy.md","tags":[],"version":"2.24","frontMatter":{},"sidebar":"docs","previous":{"title":"Horizontal Pod Autoscaling","permalink":"/constellation/getting-started/examples/horizontal-scaling"},"next":{"title":"Workflows","permalink":"/constellation/category/workflows"}}');var o=t(74848),a=t(28453);const r={},c="Deploying Filestash",l={},i=[];function d(e){const s={a:"a",code:"code",h1:"h1",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(s.header,{children:(0,o.jsx)(s.h1,{id:"deploying-filestash",children:"Deploying Filestash"})}),"\n",(0,o.jsx)(s.p,{children:"Filestash is a web frontend for different storage backends, including S3.\nIt's a useful application to showcase s3proxy in action."}),"\n",(0,o.jsxs)(s.ol,{children:["\n",(0,o.jsxs)(s.li,{children:["Deploy s3proxy as described in ",(0,o.jsx)(s.a,{href:"/constellation/workflows/s3proxy#deployment",children:"Deployment"}),"."]}),"\n",(0,o.jsx)(s.li,{children:"Create a deployment file for Filestash with one pod:"}),"\n"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-sh",children:'cat << EOF > "deployment-filestash.yaml"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n    name: filestash\nspec:\n    replicas: 1\n    selector:\n        matchLabels:\n            app: filestash\n    template:\n        metadata:\n            labels:\n                app: filestash\n        spec:\n          hostAliases:\n          - ip: $(kubectl get svc s3proxy-service -o=jsonpath=\'{.spec.clusterIP}\')\n            hostnames:\n            - "s3.us-east-1.amazonaws.com"\n            - "s3.us-east-2.amazonaws.com"\n            - "s3.us-west-1.amazonaws.com"\n            - "s3.us-west-2.amazonaws.com"\n            - "s3.eu-north-1.amazonaws.com"\n            - "s3.eu-south-1.amazonaws.com"\n            - "s3.eu-south-2.amazonaws.com"\n            - "s3.eu-west-1.amazonaws.com"\n            - "s3.eu-west-2.amazonaws.com"\n            - "s3.eu-west-3.amazonaws.com"\n            - "s3.eu-central-1.amazonaws.com"\n            - "s3.eu-central-2.amazonaws.com"\n            - "s3.ap-northeast-1.amazonaws.com"\n            - "s3.ap-northeast-2.amazonaws.com"\n            - "s3.ap-northeast-3.amazonaws.com"\n            - "s3.ap-east-1.amazonaws.com"\n            - "s3.ap-southeast-1.amazonaws.com"\n            - "s3.ap-southeast-2.amazonaws.com"\n            - "s3.ap-southeast-3.amazonaws.com"\n            - "s3.ap-southeast-4.amazonaws.com"\n            - "s3.ap-south-1.amazonaws.com"\n            - "s3.ap-south-2.amazonaws.com"\n            - "s3.me-south-1.amazonaws.com"\n            - "s3.me-central-1.amazonaws.com"\n            - "s3.il-central-1.amazonaws.com"\n            - "s3.af-south-1.amazonaws.com"\n            - "s3.ca-central-1.amazonaws.com"\n            - "s3.sa-east-1.amazonaws.com"\n          containers:\n          - name: filestash\n            image: machines/filestash:latest\n            ports:\n            - containerPort: 8334\n            volumeMounts:\n            - name: ca-cert\n              mountPath: /etc/ssl/certs/kube-ca.crt\n              subPath: kube-ca.crt\n          volumes:\n          - name: ca-cert\n            secret:\n              secretName: s3proxy-tls\n              items:\n              - key: ca.crt\n                path: kube-ca.crt\nEOF\n'})}),"\n",(0,o.jsxs)(s.p,{children:["The pod spec includes the ",(0,o.jsx)(s.code,{children:"hostAliases"})," key, which adds an entry to the pod's ",(0,o.jsx)(s.code,{children:"/etc/hosts"}),".\nThe entry forwards all requests for any of the currently defined AWS regions to the Kubernetes service ",(0,o.jsx)(s.code,{children:"s3proxy-service"}),".\nIf you followed the s3proxy ",(0,o.jsx)(s.a,{href:"/constellation/workflows/s3proxy#deployment",children:"Deployment"})," guide, this service points to a s3proxy pod."]}),"\n",(0,o.jsxs)(s.p,{children:["The deployment specifies all regions explicitly to prevent accidental data leaks.\nIf one of your buckets were located in a region that's not part of the ",(0,o.jsx)(s.code,{children:"hostAliases"})," key, traffic towards those buckets would not be redirected to s3proxy.\nSimilarly, if you want to exclude data for specific regions from going through s3proxy you can remove those regions from the deployment."]}),"\n",(0,o.jsxs)(s.p,{children:["The spec also includes a volume mount for the TLS certificate and adds it to the pod's certificate trust store.\nThe volume is called ",(0,o.jsx)(s.code,{children:"ca-cert"}),".\nThe key ",(0,o.jsx)(s.code,{children:"ca.crt"})," of that volume is mounted to ",(0,o.jsx)(s.code,{children:"/etc/ssl/certs/kube-ca.crt"}),", which is the default certificate trust store location for that container's OpenSSL library.\nNot adding the CA certificate will result in TLS authentication errors."]}),"\n",(0,o.jsxs)(s.ol,{start:"3",children:["\n",(0,o.jsxs)(s.li,{children:["Apply the file: ",(0,o.jsx)(s.code,{children:"kubectl apply -f deployment-filestash.yaml"})]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["Afterward, you can use a port forward to access the Filestash pod:\n",(0,o.jsx)(s.code,{children:"kubectl port-forward pod/$(kubectl get pod --selector='app=filestash' -o=jsonpath='{.items[*].metadata.name}') 8334:8334"})]}),"\n",(0,o.jsxs)(s.ol,{start:"4",children:["\n",(0,o.jsxs)(s.li,{children:["\n",(0,o.jsxs)(s.p,{children:["After browsing to ",(0,o.jsx)(s.code,{children:"localhost:8443"}),", Filestash will ask you to set an administrator password.\nAfter setting it, you can directly leave the admin area by clicking the blue cloud symbol in the top left corner.\nSubsequently, you can select S3 as storage backend and enter your credentials.\nThis will bring you to an overview of your buckets.\nIf you want to deploy Filestash in production, take a look at its ",(0,o.jsx)(s.a,{href:"https://www.filestash.app/docs/",children:"documentation"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(s.li,{children:["\n",(0,o.jsxs)(s.p,{children:["To see the logs of s3proxy intercepting requests made to S3, run: ",(0,o.jsx)(s.code,{children:"kubectl logs -f pod/$(kubectl get pod --selector='app=s3proxy' -o=jsonpath='{.items[*].metadata.name}')"}),"\nLook out for log messages labeled ",(0,o.jsx)(s.code,{children:"intercepting"}),".\nThere is one such log message for each message that's encrypted, decrypted, or blocked."]}),"\n"]}),"\n",(0,o.jsxs)(s.li,{children:["\n",(0,o.jsxs)(s.p,{children:["Once you have uploaded a file with Filestash, you should be able to view the file in Filestash.\nHowever, if you go to the AWS S3 ",(0,o.jsx)(s.a,{href:"https://s3.console.aws.amazon.com/s3/home",children:"Web UI"})," and download the file you just uploaded in Filestash, you won't be able to read it.\nAnother way to spot encrypted files without downloading them is to click on a file, scroll to the Metadata section, and look for the header named ",(0,o.jsx)(s.code,{children:"x-amz-meta-constellation-encryption"}),".\nThis header holds the encrypted data encryption key of the object and is only present on objects that are encrypted by s3proxy."]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,o.jsx)(s,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,s,t)=>{t.d(s,{R:()=>r,x:()=>c});var n=t(96540);const o={},a=n.createContext(o);function r(e){const s=n.useContext(a);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),n.createElement(a.Provider,{value:s},e.children)}}}]);