load("@io_bazel_rules_go//go:def.bzl", "go_library")
load("//bazel/go:go_test.bzl", "go_test")

go_library(
    name = "provider",
    srcs = [
        "example_resource.go",
        "image_data_source.go",
        "provider.go",
    ],
    importpath = "github.com/edgelesssys/constellation/v2/terraform-provider-constellation/internal/provider",
    visibility = ["//terraform-provider-constellation:__subpackages__"],
    deps = [
        "//internal/attestation/variant",
        "//internal/cloud/cloudprovider",
        "//internal/imagefetcher",
        "//terraform-provider-constellation/internal/data",
        "@com_github_hashicorp_terraform_plugin_framework//datasource",
        "@com_github_hashicorp_terraform_plugin_framework//datasource/schema",
        "@com_github_hashicorp_terraform_plugin_framework//path",
        "@com_github_hashicorp_terraform_plugin_framework//provider",
        "@com_github_hashicorp_terraform_plugin_framework//provider/schema",
        "@com_github_hashicorp_terraform_plugin_framework//resource",
        "@com_github_hashicorp_terraform_plugin_framework//resource/schema",
        "@com_github_hashicorp_terraform_plugin_framework//resource/schema/planmodifier",
        "@com_github_hashicorp_terraform_plugin_framework//resource/schema/stringdefault",
        "@com_github_hashicorp_terraform_plugin_framework//resource/schema/stringplanmodifier",
        "@com_github_hashicorp_terraform_plugin_framework//schema/validator",
        "@com_github_hashicorp_terraform_plugin_framework//types",
        "@com_github_hashicorp_terraform_plugin_framework_validators//stringvalidator",
        "@com_github_hashicorp_terraform_plugin_log//tflog",
    ],
)

go_test(
    name = "provider_test",
    srcs = [
        "image_data_source_test.go",
        "provider_test.go",
    ],
    embed = [":provider"],
    deps = [
        "@com_github_hashicorp_terraform_plugin_framework//providerserver",
        "@com_github_hashicorp_terraform_plugin_go//tfprotov6",
        "@com_github_hashicorp_terraform_plugin_testing//helper/resource",
        "@io_bazel_rules_go//go/runfiles:go_default_library",
    ],
)

go_test(
    name = "provider_acc_test",
    srcs = [
        "image_data_source_test.go",
        "provider_test.go",
    ],
    # keep
    count = 1,
    data = [
        "//bazel/ci:com_github_hashicorp_terraform",
    ],
    embed = [":provider"],
    # keep
    env = {
        "TF_ACC": "1",
        "TF_ACC_TERRAFORM_PATH": "$(rlocationpath //bazel/ci:com_github_hashicorp_terraform)",
        "TF_ACC_TEMP_DIR": "$TMPDIR", # /tmp is not writable on CI runners, use $TMPDIR instead
    },
    # keep
    tags = [
        "integration",
        "requires-network",
    ],
    # keep
    x_defs = {"runsUnder": "bazel"},
    deps = [
        "@com_github_hashicorp_terraform_plugin_framework//providerserver",
        "@com_github_hashicorp_terraform_plugin_go//tfprotov6",
        "@com_github_hashicorp_terraform_plugin_testing//helper/resource",
        "@io_bazel_rules_go//go/runfiles:go_default_library",
    ],
)
