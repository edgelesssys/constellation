"use strict";(globalThis.webpackChunkconstellation_docs=globalThis.webpackChunkconstellation_docs||[]).push([[6032],{28453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>a});var t=s(96540);const o={},i=t.createContext(o);function r(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),t.createElement(i.Provider,{value:n},e.children)}},54648:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"workflows/troubleshooting","title":"Troubleshooting","description":"This section aids you in finding problems when working with Constellation.","source":"@site/versioned_docs/version-2.22/workflows/troubleshooting.md","sourceDirName":"workflows","slug":"/workflows/troubleshooting","permalink":"/constellation/2.22/workflows/troubleshooting","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/constellation/edit/main/docs/versioned_docs/version-2.22/workflows/troubleshooting.md","tags":[],"version":"2.22","frontMatter":{},"sidebar":"docs","previous":{"title":"Reproduce release artifacts","permalink":"/constellation/2.22/workflows/reproducible-builds"},"next":{"title":"Architecture","permalink":"/constellation/2.22/category/architecture"}}');var o=s(74848),i=s(28453);const r={},a="Troubleshooting",l={},c=[{value:"Common issues",id:"common-issues",level:2},{value:"Issues with creating new clusters",id:"issues-with-creating-new-clusters",level:3},{value:"Azure: Resource Providers can&#39;t be registered",id:"azure-resource-providers-cant-be-registered",level:3},{value:"Azure: Can&#39;t update attestation policy",id:"azure-cant-update-attestation-policy",level:3},{value:"Nodes fail to join with error <code>untrusted measurement value</code>",id:"nodes-fail-to-join-with-error-untrusted-measurement-value",level:3},{value:"Upgrading Kubernetes resources fails",id:"upgrading-kubernetes-resources-fails",level:3},{value:"Diagnosing issues",id:"diagnosing-issues",level:2},{value:"Logs",id:"logs",level:3},{value:"Node shell access",id:"node-shell-access",level:3},{value:"Emergency SSH access",id:"emergency-ssh-access",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"troubleshooting",children:"Troubleshooting"})}),"\n",(0,o.jsx)(n.p,{children:"This section aids you in finding problems when working with Constellation."}),"\n",(0,o.jsx)(n.h2,{id:"common-issues",children:"Common issues"}),"\n",(0,o.jsx)(n.h3,{id:"issues-with-creating-new-clusters",children:"Issues with creating new clusters"}),"\n",(0,o.jsxs)(n.p,{children:["When you create a new cluster, you should always use the ",(0,o.jsx)(n.a,{href:"https://github.com/edgelesssys/constellation/releases/latest",children:"latest release"}),".\nIf something doesn't work, check out the ",(0,o.jsx)(n.a,{href:"https://github.com/edgelesssys/constellation/issues?q=is%3Aopen+is%3Aissue+label%3A%22known+issue%22",children:"known issues"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"azure-resource-providers-cant-be-registered",children:"Azure: Resource Providers can't be registered"}),"\n",(0,o.jsxs)(n.p,{children:["On Azure, you may receive the following error when running ",(0,o.jsx)(n.code,{children:"apply"})," or ",(0,o.jsx)(n.code,{children:"terminate"})," with limited IAM permissions:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell-session",children:"Error: Error ensuring Resource Providers are registered.\n\nTerraform automatically attempts to register the Resource Providers it supports to\nensure it's able to provision resources.\n\nIf you don't have permission to register Resource Providers you may wish to use the\n\"skip_provider_registration\" flag in the Provider block to disable this functionality.\n\n[...]\n"})}),"\n",(0,o.jsxs)(n.p,{children:["To continue, please ensure that the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/getting-started/install#required-permissions",children:"required resource providers"})," have been registered in your subscription by your administrator."]}),"\n",(0,o.jsxs)(n.p,{children:["Afterward, set ",(0,o.jsx)(n.code,{children:"ARM_SKIP_PROVIDER_REGISTRATION=true"})," as an environment variable and either run ",(0,o.jsx)(n.code,{children:"apply"})," or ",(0,o.jsx)(n.code,{children:"terminate"})," again.\nFor example:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"ARM_SKIP_PROVIDER_REGISTRATION=true constellation apply\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Or alternatively, for ",(0,o.jsx)(n.code,{children:"terminate"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"ARM_SKIP_PROVIDER_REGISTRATION=true constellation terminate\n"})}),"\n",(0,o.jsx)(n.h3,{id:"azure-cant-update-attestation-policy",children:"Azure: Can't update attestation policy"}),"\n",(0,o.jsxs)(n.p,{children:["On Azure, you may receive the following error when running ",(0,o.jsx)(n.code,{children:"apply"})," from within an Azure environment, e.g., an Azure VM:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell-session",children:"An error occurred: patching policies: updating attestation policy: unexpected status code: 403 Forbidden\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The problem occurs because the Azure SDK we use internally attempts to ",(0,o.jsx)(n.a,{href:"https://pkg.go.dev/github.com/Azure/azure-sdk-for-go/sdk/azidentity#DefaultAzureCredential",children:"authenticate towards the Azure API with the managed identity of your current environment instead of the Azure CLI token"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"We decided not to deviate from this behavior and comply with the ordering of credentials."}),"\n",(0,o.jsxs)(n.p,{children:["A solution is to add the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/getting-started/install#required-permissions",children:"required permissions"})," to the managed identity of your environment. For example, the managed identity of your Azure VM, instead of the account that you've authenticated with in the Azure CLI."]}),"\n",(0,o.jsx)(n.p,{children:"If your setup requires a change in the ordering of credentials, please open an issue and explain your desired behavior."}),"\n",(0,o.jsxs)(n.h3,{id:"nodes-fail-to-join-with-error-untrusted-measurement-value",children:["Nodes fail to join with error ",(0,o.jsx)(n.code,{children:"untrusted measurement value"})]}),"\n",(0,o.jsxs)(n.p,{children:["This error indicates that a node's ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/attestation",children:"attestation statement"})," contains measurements that don't match the trusted values expected by the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/microservices#joinservice",children:"JoinService"}),".\nThis may for example happen if the cloud provider updates the VM's firmware such that it influences the ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/attestation#runtime-measurements",children:"runtime measurements"})," in an unforeseen way.\nA failed upgrade due to an erroneous attestation config can also cause this error.\nYou can change the expected measurements to resolve the failure."]}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsxs)(n.p,{children:["Attestation and trusted measurements are crucial for the security of your cluster.\nBe extra careful when manually changing these settings.\nWhen in doubt, check if the encountered ",(0,o.jsx)(n.a,{href:"https://github.com/edgelesssys/constellation/issues?q=is%3Aopen+is%3Aissue+label%3A%22known+issue%22",children:"issue is known"})," or ",(0,o.jsx)(n.a,{href:"https://github.com/edgelesssys/constellation#support",children:"contact support"}),"."]})}),"\n",(0,o.jsxs)(n.admonition,{type:"tip",children:[(0,o.jsxs)(n.p,{children:["During an upgrade with modified attestation config, a backup of the current configuration is stored in the ",(0,o.jsx)(n.code,{children:"join-config"})," config map in the ",(0,o.jsx)(n.code,{children:"kube-system"})," namespace under the ",(0,o.jsx)(n.code,{children:"attestationConfig_backup"})," key. To restore the old attestation config after a failed upgrade, replace the value of ",(0,o.jsx)(n.code,{children:"attestationConfig"})," with the value from ",(0,o.jsx)(n.code,{children:"attestationConfig_backup"}),":"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'kubectl patch configmaps -n kube-system join-config -p "{\\"data\\":{\\"attestationConfig\\":\\"$(kubectl get configmaps -n kube-system join-config -o "jsonpath={.data.attestationConfig_backup}")\\"}}"\n'})})]}),"\n",(0,o.jsxs)(n.p,{children:["You can use the ",(0,o.jsx)(n.code,{children:"apply"})," command to change measurements of a running cluster:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Modify the ",(0,o.jsx)(n.code,{children:"measurements"})," key in your local ",(0,o.jsx)(n.code,{children:"constellation-conf.yaml"})," to the expected values."]}),"\n",(0,o.jsxs)(n.li,{children:["Run ",(0,o.jsx)(n.code,{children:"constellation apply"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Keep in mind that running ",(0,o.jsx)(n.code,{children:"apply"})," also applies any version changes from your config to the cluster."]}),"\n",(0,o.jsx)(n.p,{children:"You can run these commands to learn about the versions currently configured in the cluster:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Kubernetes API server version: ",(0,o.jsx)(n.code,{children:"kubectl get nodeversion constellation-version -o json -n kube-system | jq .spec.kubernetesClusterVersion"})]}),"\n",(0,o.jsxs)(n.li,{children:["image version: ",(0,o.jsx)(n.code,{children:"kubectl get nodeversion constellation-version -o json -n kube-system | jq .spec.imageVersion"})]}),"\n",(0,o.jsxs)(n.li,{children:["microservices versions: ",(0,o.jsx)(n.code,{children:"helm list --filter 'constellation-services' -n kube-system"})]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"upgrading-kubernetes-resources-fails",children:"Upgrading Kubernetes resources fails"}),"\n",(0,o.jsxs)(n.p,{children:["Constellation manages its Kubernetes resources using Helm.\nWhen applying an upgrade, the charts that are about to be installed, and a values override file ",(0,o.jsx)(n.code,{children:"overrides.yaml"}),",\nare saved to disk in your current workspace under ",(0,o.jsx)(n.code,{children:"constellation-upgrade/upgrade-<timestamp>/helm-charts/"}),".\nIf upgrading the charts using the Constellation CLI fails, you can review these charts and try to manually apply the upgrade."]}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsxs)(n.p,{children:["Changing and manually applying the charts may destroy cluster resources and can lead to broken Constellation deployments.\nProceed with caution and when in doubt,\ncheck if the encountered ",(0,o.jsx)(n.a,{href:"https://github.com/edgelesssys/constellation/issues?q=is%3Aopen+is%3Aissue+label%3A%22known+issue%22",children:"issue is known"})," or ",(0,o.jsx)(n.a,{href:"https://github.com/edgelesssys/constellation#support",children:"contact support"}),"."]})}),"\n",(0,o.jsx)(n.h2,{id:"diagnosing-issues",children:"Diagnosing issues"}),"\n",(0,o.jsx)(n.h3,{id:"logs",children:"Logs"}),"\n",(0,o.jsxs)(n.p,{children:["To get started on diagnosing issues with Constellation, it's often helpful to collect logs from nodes, pods, or other resources in the cluster. Most logs are available through Kubernetes' standard\n",(0,o.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/cluster-administration/logging/",children:"logging interfaces"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"To debug issues occurring at boot time of the nodes, you can use the serial console interface of the CSP while the machine boots to get a read-only view of the boot logs."}),"\n",(0,o.jsxs)(n.p,{children:["Apart from that, Constellation also offers further ",(0,o.jsx)(n.a,{href:"/constellation/2.22/architecture/observability",children:"observability integrations"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"node-shell-access",children:"Node shell access"}),"\n",(0,o.jsxs)(n.p,{children:["Debugging via a shell on a node is ",(0,o.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/debug/debug-application/debug-running-pod/#node-shell-session",children:"directly supported by Kubernetes"}),"."]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Figure out which node to connect to:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kubectl get nodes\n# or to see more information, such as IPs:\nkubectl get nodes -o wide\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Connect to the node:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kubectl debug node/constell-worker-xksa0-000000 -it --image=busybox\n"})}),"\n",(0,o.jsx)(n.p,{children:"You will be presented with a prompt."}),"\n",(0,o.jsxs)(n.p,{children:["The nodes file system is mounted at ",(0,o.jsx)(n.code,{children:"/host"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Once finished, clean up the debug pod:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kubectl delete pod node-debugger-constell-worker-xksa0-000000-bjthj\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"emergency-ssh-access",children:"Emergency SSH access"}),"\n",(0,o.jsx)(n.p,{children:"Emergency SSH access to nodes can be useful to diagnose issues or download important data even if the Kubernetes API isn't reachable anymore."}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Enter the ",(0,o.jsx)(n.code,{children:"constellation-terraform"})," directory in your Constellation workspace and enable emergency SSH access to the cluster:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:' cd constellation-terraform\n echo "emergency_ssh = true" >> ./terraform.tfvars\n terraform apply\n'})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Sign an existing SSH key with your master secret:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"cd ../ # go back to your Constellation workspace\nconstellation ssh --key your_public_key.pub\n"})}),"\n",(0,o.jsxs)(n.p,{children:["A certificate is written to ",(0,o.jsx)(n.code,{children:"constellation_cert.pub"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["The certificate is valid for 24 hours and enables you to access your Constellation nodes using\n",(0,o.jsx)(n.a,{href:"https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Certificate-based_Authentication",children:"certificate based authentication"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Now you can connect to any Constellation node using your certificate and your private key."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"ssh -o CertificateFile=constellation_cert.pub -i <your private key> root@<ip of constellation node>\n"})}),"\n",(0,o.jsx)(n.p,{children:"Normally, you don't have access to the Constellation nodes since they reside in a private network.\nTo access those nodes anyways, you can use your Constellation load balancer as a proxy jump host.\nFor this, use something along the following SSH client configuration:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-text",children:"Host <LB domain name>\n  ProxyJump none\n\nHost *\n  IdentityFile <your private key>\n  PreferredAuthentications publickey\n  CertificateFile=constellation_cert.pub\n  User root\n  ProxyJump <LB domain name>\n"})}),"\n",(0,o.jsxs)(n.p,{children:["With this configuration you can connect to a Constellation node using ",(0,o.jsx)(n.code,{children:"ssh -F <this config> <private node IP>"}),".\nYou can obtain the private node IP and the domain name of the load balancer using your CSP's web UI."]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);