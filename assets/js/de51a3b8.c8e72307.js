"use strict";(globalThis.webpackChunkconstellation_docs=globalThis.webpackChunkconstellation_docs||[]).push([[1618],{9122:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"workflows/terraform-provider","title":"Use the Terraform provider","description":"The Constellation Terraform provider allows to manage the full lifecycle of a Constellation cluster (namely creation, upgrades, and deletion) via Terraform.","source":"@site/versioned_docs/version-2.23/workflows/terraform-provider.md","sourceDirName":"workflows","slug":"/workflows/terraform-provider","permalink":"/constellation/2.23/workflows/terraform-provider","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/constellation/edit/main/docs/versioned_docs/version-2.23/workflows/terraform-provider.md","tags":[],"version":"2.23","frontMatter":{},"sidebar":"docs","previous":{"title":"Use persistent storage","permalink":"/constellation/2.23/workflows/storage"},"next":{"title":"Consume SBOMs","permalink":"/constellation/2.23/workflows/sbom"}}');var t=n(74848),s=n(28453);const i={},a="Use the Terraform provider",l={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Quick setup",id:"quick-setup",level:2},{value:"Bringing your own infrastructure",id:"bringing-your-own-infrastructure",level:2},{value:"Cluster upgrades",id:"cluster-upgrades",level:2}];function d(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components},{TabItem:n,Tabs:o}=r;return n||h("TabItem",!0),o||h("Tabs",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"use-the-terraform-provider",children:"Use the Terraform provider"})}),"\n",(0,t.jsxs)(r.p,{children:["The Constellation Terraform provider allows to manage the full lifecycle of a Constellation cluster (namely creation, upgrades, and deletion) via Terraform.\nThe provider is available through the ",(0,t.jsx)(r.a,{href:"https://registry.terraform.io/providers/edgelesssys/constellation/latest",children:"Terraform registry"})," and is released in lock-step with Constellation releases."]}),"\n",(0,t.jsx)(r.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"a Linux / Mac operating system (ARM64/AMD64)"}),"\n",(0,t.jsxs)(r.li,{children:["a Terraform installation of version ",(0,t.jsx)(r.code,{children:"v1.4.4"})," or above"]}),"\n"]}),"\n",(0,t.jsx)(r.h2,{id:"quick-setup",children:"Quick setup"}),"\n",(0,t.jsxs)(r.p,{children:["This example shows how to set up a Constellation cluster with the reference IAM and infrastructure setup. This setup is also used when creating a Constellation cluster through the Constellation CLI. You can either consume the IAM / infrastructure modules through a remote source (recommended) or local files. The latter requires downloading the infrastructure and IAM modules for the corresponding CSP from ",(0,t.jsx)(r.code,{children:"terraform-modules.zip"})," on the ",(0,t.jsx)(r.a,{href:"https://github.com/edgelesssys/constellation/releases/latest",children:"Constellation release page"})," and placing them in the Terraform workspace directory."]}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Create a directory (workspace) for your Constellation cluster."}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"mkdir constellation-workspace\ncd constellation-workspace\n"})}),"\n",(0,t.jsxs)(r.ol,{start:"2",children:["\n",(0,t.jsxs)(r.li,{children:["Use one of the ",(0,t.jsx)(r.a,{href:"https://github.com/edgelesssys/constellation/tree/main/terraform-provider-constellation/examples/full",children:"example configurations for using the Constellation Terraform provider"})," or create a ",(0,t.jsx)(r.code,{children:"main.tf"})," file and fill it with the resources you want to create. The ",(0,t.jsx)(r.a,{href:"https://registry.terraform.io/providers/edgelesssys/constellation/latest",children:"Constellation Terraform provider documentation"})," offers thorough documentation on the resources and their attributes."]}),"\n",(0,t.jsx)(r.li,{children:"Initialize and apply the Terraform configuration."}),"\n"]}),"\n",(0,t.jsxs)(o,{groupId:"csp",children:[(0,t.jsxs)(n,{value:"aws",label:"AWS",children:[(0,t.jsx)(r.p,{children:"Initialize the providers and apply the configuration."}),(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"terraform init\nterraform apply\n"})}),(0,t.jsxs)(r.p,{children:["Optionally, you can prefix the ",(0,t.jsx)(r.code,{children:"terraform apply"})," command with ",(0,t.jsx)(r.code,{children:"TF_LOG=INFO"})," to collect ",(0,t.jsx)(r.a,{href:"https://developer.hashicorp.com/terraform/internals/debugging",children:"Terraform logs"})," while applying the configuration. This may provide helpful output in debugging scenarios."]})]}),(0,t.jsxs)(n,{value:"azure",label:"Azure",children:[(0,t.jsxs)(r.admonition,{type:"info",children:[(0,t.jsx)(r.p,{children:"On SEV-SNP, you need to manually patch the policy of the MAA provider before creating the Constellation cluster, as this feature isn't available in Azure's Terraform provider yet. The Constellation CLI provides a utility for patching, but you can also do it manually."}),(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"terraform init\nterraform apply -target module.azure_iam # adjust resource path if not using the example configuration\nterraform apply -target module.azure_infrastructure # adjust resource path if not using the example configuration\nconstellation maa-patch $(terraform output -raw maa_url) # adjust output path / input if not using the example configuration or manually patch the resource\nterraform apply -target constellation_cluster.azure_example # adjust resource path if not using the example configuration\n"})}),(0,t.jsx)(r.p,{children:"Use the following policy if manually performing the patch."}),(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:'version= 1.0;\nauthorizationrules\n{\n    [type=="x-ms-azurevm-default-securebootkeysvalidated", value==false] => deny();\n    [type=="x-ms-azurevm-debuggersdisabled", value==false] => deny();\n    // The line below was edited to use the MAA provider within Constellation. Do not edit manually.\n    //[type=="secureboot", value==false] => deny();\n    [type=="x-ms-azurevm-signingdisabled", value==false] => deny();\n    [type=="x-ms-azurevm-dbvalidated", value==false] => deny();\n    [type=="x-ms-azurevm-dbxvalidated", value==false] => deny();\n    => permit();\n};\nissuancerules\n{\n};\n'})})]}),(0,t.jsx)(r.p,{children:"Initialize the providers and apply the configuration."}),(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"terraform init\nterraform apply\n"})}),(0,t.jsxs)(r.p,{children:["Optionally, you can prefix the ",(0,t.jsx)(r.code,{children:"terraform apply"})," command with ",(0,t.jsx)(r.code,{children:"TF_LOG=INFO"})," to collect ",(0,t.jsx)(r.a,{href:"https://developer.hashicorp.com/terraform/internals/debugging",children:"Terraform logs"})," while applying the configuration. This may provide helpful output in debugging scenarios."]})]}),(0,t.jsxs)(n,{value:"gcp",label:"GCP",children:[(0,t.jsx)(r.p,{children:"Initialize the providers and apply the configuration."}),(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"terraform init\nterraform apply\n"})}),(0,t.jsxs)(r.p,{children:["Optionally, you can prefix the ",(0,t.jsx)(r.code,{children:"terraform apply"})," command with ",(0,t.jsx)(r.code,{children:"TF_LOG=INFO"})," to collect ",(0,t.jsx)(r.a,{href:"https://developer.hashicorp.com/terraform/internals/debugging",children:"Terraform logs"})," while applying the configuration. This may provide helpful output in debugging scenarios."]})]}),(0,t.jsxs)(n,{value:"stackit",label:"STACKIT",children:[(0,t.jsx)(r.p,{children:"Initialize the providers and apply the configuration."}),(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"terraform init\nterraform apply\n"})}),(0,t.jsxs)(r.p,{children:["Optionally, you can prefix the ",(0,t.jsx)(r.code,{children:"terraform apply"})," command with ",(0,t.jsx)(r.code,{children:"TF_LOG=INFO"})," to collect ",(0,t.jsx)(r.a,{href:"https://developer.hashicorp.com/terraform/internals/debugging",children:"Terraform logs"})," while applying the configuration. This may provide helpful output in debugging scenarios."]})]})]}),"\n",(0,t.jsxs)(r.ol,{start:"4",children:["\n",(0,t.jsx)(r.li,{children:"Connect to the cluster."}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"terraform output -raw kubeconfig > constellation-admin.conf\nexport KUBECONFIG=$(realpath constellation-admin.conf)\n"})}),"\n",(0,t.jsx)(r.h2,{id:"bringing-your-own-infrastructure",children:"Bringing your own infrastructure"}),"\n",(0,t.jsxs)(r.p,{children:["Instead of using the example infrastructure used in the ",(0,t.jsx)(r.a,{href:"#quick-setup",children:"quick setup"}),", you can also provide your own infrastructure.\nIf you need a starting point for a custom infrastructure setup, you can download the infrastructure / IAM Terraform modules for the respective CSP from the Constellation ",(0,t.jsx)(r.a,{href:"https://github.com/edgelesssys/constellation/releases",children:"GitHub releases"}),". You can modify and extend the modules per your requirements, while keeping the basic functionality intact.\nThe module contains:"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"{csp}"}),": cloud resources the cluster runs on"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"iam/{csp}"}),": IAM resources used within the cluster"]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"When upgrading your cluster, make sure to check the Constellation release notes for potential breaking changes in the reference infrastructure / IAM modules that need to be considered."}),"\n",(0,t.jsx)(r.h2,{id:"cluster-upgrades",children:"Cluster upgrades"}),"\n",(0,t.jsx)(r.admonition,{type:"tip",children:(0,t.jsxs)(r.p,{children:["Also see the ",(0,t.jsx)(r.a,{href:"/constellation/2.23/workflows/upgrade",children:"general documentation on cluster upgrades"}),"."]})}),"\n",(0,t.jsx)(r.p,{children:"The steps for applying the upgrade are as follows:"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:["Update the version constraint of the Constellation Terraform provider in the ",(0,t.jsx)(r.code,{children:"required_providers"})," block in your Terraform configuration."]}),"\n",(0,t.jsxs)(r.li,{children:["If you explicitly set any of the version attributes of the provider's resources and data sources (e.g. ",(0,t.jsx)(r.code,{children:"image_version"})," or ",(0,t.jsx)(r.code,{children:"constellation_microservice_version"}),"), make sure to update them too. Refer to Constellation's ",(0,t.jsx)(r.a,{href:"https://github.com/edgelesssys/constellation/blob/main/dev-docs/workflows/versions-support.md",children:"version support policy"})," for more information on how each Constellation version and its dependencies are supported."]}),"\n",(0,t.jsxs)(r.li,{children:["Update the IAM / infrastructure configuration.","\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["For ",(0,t.jsx)(r.a,{href:"https://developer.hashicorp.com/terraform/language/modules/sources#fetching-archives-over-http",children:"remote addresses as module sources"}),", update the version number inside the address of the ",(0,t.jsx)(r.code,{children:"source"})," field of the infrastructure / IAM module to the target version."]}),"\n",(0,t.jsxs)(r.li,{children:["For ",(0,t.jsx)(r.a,{href:"https://developer.hashicorp.com/terraform/language/modules/sources#local-paths",children:"local paths as module sources"})," or when ",(0,t.jsx)(r.a,{href:"#bringing-your-own-infrastructure",children:"providing your own infrastructure"}),", see the changes made in the reference modules since the upgrade's origin version and adjust your infrastructure / IAM configuration accordingly."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.li,{children:"Upgrade the Terraform module and provider dependencies and apply the targeted configuration."}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"  terraform init -upgrade\n  terraform apply\n"})})]})}function u(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}function h(e,r){throw new Error("Expected "+(r?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},28453:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>a});var o=n(96540);const t={},s=o.createContext(t);function i(e){const r=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),o.createElement(s.Provider,{value:r},e.children)}}}]);