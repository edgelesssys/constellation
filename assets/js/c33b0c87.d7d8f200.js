"use strict";(globalThis.webpackChunkconstellation_docs=globalThis.webpackChunkconstellation_docs||[]).push([[8518],{8519:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"getting-started/examples/horizontal-scaling","title":"Horizontal Pod Autoscaling","description":"This example demonstrates Constellation\'s autoscaling capabilities. It\'s based on the Kubernetes HorizontalPodAutoscaler Walkthrough. During the following steps, Constellation will spawn new VMs on demand, verify them, add them to the cluster, and delete them again when the load has settled down.","source":"@site/versioned_docs/version-2.22/getting-started/examples/horizontal-scaling.md","sourceDirName":"getting-started/examples","slug":"/getting-started/examples/horizontal-scaling","permalink":"/constellation/2.22/getting-started/examples/horizontal-scaling","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/constellation/edit/main/docs/versioned_docs/version-2.22/getting-started/examples/horizontal-scaling.md","tags":[],"version":"2.22","frontMatter":{},"sidebar":"docs","previous":{"title":"Online Boutique","permalink":"/constellation/2.22/getting-started/examples/online-boutique"},"next":{"title":"Filestash with s3proxy","permalink":"/constellation/2.22/getting-started/examples/filestash-s3proxy"}}');var a=t(74848),o=t(28453);const i={},l="Horizontal Pod Autoscaling",r={},c=[{value:"Requirements",id:"requirements",level:2},{value:"Setup",id:"setup",level:2},{value:"Monitoring",id:"monitoring",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"horizontal-pod-autoscaling",children:"Horizontal Pod Autoscaling"})}),"\n",(0,a.jsxs)(n.p,{children:["This example demonstrates Constellation's autoscaling capabilities. It's based on the Kubernetes ",(0,a.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/",children:"HorizontalPodAutoscaler Walkthrough"}),". During the following steps, Constellation will spawn new VMs on demand, verify them, add them to the cluster, and delete them again when the load has settled down."]}),"\n",(0,a.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,a.jsxs)(n.p,{children:["The cluster needs to be initialized with Kubernetes 1.23 or later. In addition, ",(0,a.jsx)(n.a,{href:"/constellation/2.22/workflows/scale",children:"autoscaling must be enabled"})," to enable Constellation to assign new nodes dynamically."]}),"\n",(0,a.jsxs)(n.p,{children:["Just for this example specifically, the cluster should have as few worker nodes in the beginning as possible. Start with a small cluster with only ",(0,a.jsx)(n.em,{children:"one"})," low-powered node for the control-plane node and ",(0,a.jsx)(n.em,{children:"one"})," low-powered worker node."]}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsxs)(n.p,{children:["We tested the example using instances of types ",(0,a.jsx)(n.code,{children:"Standard_DC4as_v5"})," on Azure and ",(0,a.jsx)(n.code,{children:"n2d-standard-4"})," on GCP."]})}),"\n",(0,a.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Install the Kubernetes Metrics Server:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Deploy the HPA example server that's supposed to be scaled under load."}),"\n",(0,a.jsx)(n.p,{children:"This manifest is similar to the one from the Kubernetes HPA walkthrough, but with increased CPU limits and requests to facilitate the triggering of node scaling events."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"cat <<EOF | kubectl apply -f -\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: php-apache\nspec:\n  selector:\n    matchLabels:\n      run: php-apache\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        run: php-apache\n    spec:\n      containers:\n      - name: php-apache\n        image: registry.k8s.io/hpa-example\n        ports:\n        - containerPort: 80\n        resources:\n          limits:\n            cpu: 900m\n          requests:\n            cpu: 600m\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: php-apache\n  labels:\n    run: php-apache\nspec:\n  ports:\n  - port: 80\n  selector:\n    run: php-apache\nEOF\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Create a HorizontalPodAutoscaler."}),"\n",(0,a.jsxs)(n.p,{children:["Set an average CPU usage across all Pods of 20% to see one additional worker node being created later. Note that the CPU usage isn't related to the host CPU usage, but rather to the requested CPU capacities (20% of 600 milli-cores CPU across all Pods). See the ",(0,a.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#create-horizontal-pod-autoscaler",children:"original tutorial"})," for more information on the HPA configuration."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl autoscale deployment php-apache --cpu-percent=20 --min=1 --max=10\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Create a Pod that generates load on the server:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'kubectl run -i --tty load-generator --rm --image=busybox:1.28 --restart=Never -- /bin/sh -c "while true; do wget -q -O- http://php-apache; done"\n'})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Wait a few minutes until new nodes are added to the cluster. You can ",(0,a.jsx)(n.a,{href:"#monitoring",children:"monitor"})," the state of the HorizontalPodAutoscaler, the list of nodes, and the behavior of the autoscaler."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"To stop the load generator, press CTRL+C and run:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl delete pod load-generator\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"The cluster-autoscaler checks every few minutes if nodes are underutilized. It will taint such candidates for removal and wait additional 10 minutes before the nodes are eventually removed and deallocated. The whole process can take about 20 minutes."}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,a.jsx)(n.admonition,{type:"tip",children:(0,a.jsx)(n.p,{children:"For better observability, run the listed commands in different tabs in your terminal."})}),"\n",(0,a.jsx)(n.p,{children:"You can watch the status of the HorizontalPodAutoscaler with the current CPU usage, the target CPU limit, and the number of replicas created with:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl get hpa php-apache --watch\n"})}),"\n",(0,a.jsx)(n.p,{children:"From time to time compare the list of nodes to check the behavior of the autoscaler:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl get nodes\n"})}),"\n",(0,a.jsx)(n.p,{children:"For deeper insights, see the logs of the autoscaler Pod, which contains more details about the scaling decision process:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl logs -f deployment/constellation-cluster-autoscaler -n kube-system\n"})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>l});var s=t(96540);const a={},o=s.createContext(a);function i(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);