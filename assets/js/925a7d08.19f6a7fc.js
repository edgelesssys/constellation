"use strict";(globalThis.webpackChunkconstellation_docs=globalThis.webpackChunkconstellation_docs||[]).push([[2813],{28453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>i});var s=r(96540);const t={},o=s.createContext(t);function a(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),s.createElement(o.Provider,{value:n},e.children)}},58096:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"workflows/upgrade","title":"Upgrade your cluster","description":"Constellation provides an easy way to upgrade all components of your cluster, without disrupting its availability.","source":"@site/versioned_docs/version-2.23/workflows/upgrade.md","sourceDirName":"workflows","slug":"/workflows/upgrade","permalink":"/constellation/2.23/workflows/upgrade","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/constellation/edit/main/docs/versioned_docs/version-2.23/workflows/upgrade.md","tags":[],"version":"2.23","frontMatter":{},"sidebar":"docs","previous":{"title":"Scale your cluster","permalink":"/constellation/2.23/workflows/scale"},"next":{"title":"Expose a service","permalink":"/constellation/2.23/workflows/lb"}}');var t=r(74848),o=r(28453);const a={},i="Upgrade your cluster",l={},c=[{value:"Update the CLI",id:"update-the-cli",level:2},{value:"Migrate the configuration",id:"migrate-the-configuration",level:2},{value:"Check for upgrades",id:"check-for-upgrades",level:2},{value:"Apply the upgrade",id:"apply-the-upgrade",level:2},{value:"Check the status",id:"check-the-status",level:2},{value:"Apply further upgrades",id:"apply-further-upgrades",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"upgrade-your-cluster",children:"Upgrade your cluster"})}),"\n",(0,t.jsxs)(n.p,{children:["Constellation provides an easy way to upgrade all components of your cluster, without disrupting its availability.\nSpecifically, you can upgrade the Kubernetes version, the nodes' image, and the Constellation microservices.\nYou configure the desired versions in your local Constellation configuration and trigger upgrades with the ",(0,t.jsx)(n.code,{children:"apply"})," command.\nTo learn about available versions you use the ",(0,t.jsx)(n.code,{children:"upgrade check"})," command.\nWhich versions are available depends on the CLI version you are using."]}),"\n",(0,t.jsx)(n.h2,{id:"update-the-cli",children:"Update the CLI"}),"\n",(0,t.jsx)(n.p,{children:"Each CLI comes with a set of supported microservice and Kubernetes versions.\nMost importantly, a given CLI version can only upgrade a cluster of the previous minor version, but not older ones.\nThis means that you have to upgrade your CLI and cluster one minor version at a time."}),"\n",(0,t.jsx)(n.p,{children:"For example, if you are currently on CLI version v2.6 and the latest version is v2.8, you should"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"upgrade the CLI to v2.7,"}),"\n",(0,t.jsx)(n.li,{children:"upgrade the cluster to v2.7,"}),"\n",(0,t.jsx)(n.li,{children:"and only then continue upgrading the CLI (and the cluster) to v2.8 after."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Also note that if your current Kubernetes version isn't supported by the next CLI version, use your current CLI to upgrade to a newer Kubernetes version first."}),"\n",(0,t.jsxs)(n.p,{children:["To learn which Kubernetes versions are supported by a particular CLI, run ",(0,t.jsx)(n.a,{href:"/constellation/2.23/reference/cli#constellation-config-kubernetes-versions",children:"constellation config kubernetes-versions"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"migrate-the-configuration",children:"Migrate the configuration"}),"\n",(0,t.jsxs)(n.p,{children:["The Constellation configuration file is located in the file ",(0,t.jsx)(n.code,{children:"constellation-conf.yaml"})," in your workspace.\nRefer to the ",(0,t.jsx)(n.a,{href:"/constellation/2.23/reference/migration",children:"migration reference"})," to check if you need to update fields in your configuration file.\nUse ",(0,t.jsx)(n.a,{href:"/constellation/2.23/reference/cli#constellation-config-migrate",children:(0,t.jsx)(n.code,{children:"constellation config migrate"})})," to automatically update an old config file to a new format."]}),"\n",(0,t.jsx)(n.h2,{id:"check-for-upgrades",children:"Check for upgrades"}),"\n",(0,t.jsx)(n.p,{children:"To learn which versions the current CLI can upgrade to and what's installed in your cluster, run:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Show possible upgrades\nconstellation upgrade check\n\n# Show possible upgrades and write them to config file\nconstellation upgrade check --update-config\n"})}),"\n",(0,t.jsxs)(n.p,{children:["You can either enter the reported target versions into your config manually or run the above command with the ",(0,t.jsx)(n.code,{children:"--update-config"})," flag.\nWhen using this flag, the ",(0,t.jsx)(n.code,{children:"kubernetesVersion"}),", ",(0,t.jsx)(n.code,{children:"image"}),", ",(0,t.jsx)(n.code,{children:"microserviceVersion"}),", and ",(0,t.jsx)(n.code,{children:"attestation"})," fields are overwritten with the smallest available upgrade."]}),"\n",(0,t.jsx)(n.h2,{id:"apply-the-upgrade",children:"Apply the upgrade"}),"\n",(0,t.jsx)(n.p,{children:"Once you updated your config with the desired versions, you can trigger the upgrade with this command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"constellation apply\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Microservice upgrades will be finished within a few minutes, depending on the cluster size.\nIf you are interested, you can monitor pods restarting in the ",(0,t.jsx)(n.code,{children:"kube-system"})," namespace with your tool of choice."]}),"\n",(0,t.jsx)(n.p,{children:"Image and Kubernetes upgrades take longer.\nFor each node in your cluster, a new node has to be created and joined.\nThe process usually takes up to ten minutes per node."}),"\n",(0,t.jsxs)(n.p,{children:["When applying an upgrade, the Helm charts for the upgrade as well as backup files of Constellation-managed Custom Resource Definitions, Custom Resources, and Terraform state are created.\nYou can use the Terraform state backup to restore previous resources in case an upgrade misconfigured or erroneously deleted a resource.\nYou can use the Custom Resource (Definition) backup files to restore Custom Resources and Definitions manually (e.g., via ",(0,t.jsx)(n.code,{children:"kubectl apply"}),") if the automatic migration of those resources fails.\nYou can use the Helm charts to manually apply upgrades to the Kubernetes resources, should an upgrade fail."]}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["For advanced users: the upgrade consists of several phases that can be individually skipped through the ",(0,t.jsx)(n.code,{children:"--skip-phases"})," flag.\nThe phases are ",(0,t.jsx)(n.code,{children:"infrastracture"})," for the cloud resource management through Terraform, ",(0,t.jsx)(n.code,{children:"helm"})," for the chart management of the microservices, ",(0,t.jsx)(n.code,{children:"image"})," for OS image upgrades, and ",(0,t.jsx)(n.code,{children:"k8s"})," for Kubernetes version upgrades."]})}),"\n",(0,t.jsx)(n.h2,{id:"check-the-status",children:"Check the status"}),"\n",(0,t.jsxs)(n.p,{children:["Upgrades are asynchronous operations.\nAfter you run ",(0,t.jsx)(n.code,{children:"apply"}),", it will take a while until the upgrade has completed.\nTo understand if an upgrade is finished, you can run:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"constellation status\n"})}),"\n",(0,t.jsx)(n.p,{children:"This command displays the following information:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"The installed services and their versions"}),"\n",(0,t.jsx)(n.li,{children:"The image and Kubernetes version the cluster is expecting on each node"}),"\n",(0,t.jsx)(n.li,{children:"How many nodes are up to date"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Here's an example output:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell-session",children:"Target versions:\n    Image: v2.6.0\n    Kubernetes: v1.25.8\nService versions:\n    Cilium: v1.12.1\n    cert-manager: v1.10.0\n    constellation-operators: v2.6.0\n    constellation-services: v2.6.0\nCluster status: Some node versions are out of date\n    Image: 23/25\n    Kubernetes: 25/25\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This output indicates that the cluster is running Kubernetes version ",(0,t.jsx)(n.code,{children:"1.25.8"}),", and all nodes have the appropriate binaries installed.\n23 out of 25 nodes have already upgraded to the targeted image version of ",(0,t.jsx)(n.code,{children:"2.6.0"}),", while two are still in progress."]}),"\n",(0,t.jsx)(n.h2,{id:"apply-further-upgrades",children:"Apply further upgrades"}),"\n",(0,t.jsxs)(n.p,{children:["After the upgrade is finished, you can run ",(0,t.jsx)(n.code,{children:"constellation upgrade check"})," again to see if there are more upgrades available. If so, repeat the process."]})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}}}]);