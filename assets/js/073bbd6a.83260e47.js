"use strict";(globalThis.webpackChunkconstellation_docs=globalThis.webpackChunkconstellation_docs||[]).push([[5514],{28453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>r});var t=s(96540);const l={},o=t.createContext(l);function i(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:i(e.components),t.createElement(o.Provider,{value:n},e.children)}},94145:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"getting-started/first-steps-local","title":"First steps with a local cluster","description":"A local cluster lets you deploy and test Constellation without a cloud subscription.","source":"@site/versioned_docs/version-2.23/getting-started/first-steps-local.md","sourceDirName":"getting-started","slug":"/getting-started/first-steps-local","permalink":"/constellation/2.23/getting-started/first-steps-local","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/constellation/edit/main/docs/versioned_docs/version-2.23/getting-started/first-steps-local.md","tags":[],"version":"2.23","frontMatter":{},"sidebar":"docs","previous":{"title":"First steps (cloud)","permalink":"/constellation/2.23/getting-started/first-steps"},"next":{"title":"Cloud Marketplaces","permalink":"/constellation/2.23/getting-started/marketplaces"}}');var l=s(74848),o=s(28453);const i={},r="First steps with a local cluster",a={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Software installation on Ubuntu",id:"software-installation-on-ubuntu",level:3},{value:"Create a cluster",id:"create-a-cluster",level:2},{value:"Connect to the cluster",id:"connect-to-the-cluster",level:2},{value:"Deploy a sample application",id:"deploy-a-sample-application",level:2},{value:"Terminate your cluster",id:"terminate-your-cluster",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"VMs have no internet access / CLI remains in &quot;Initializing cluster&quot; state",id:"vms-have-no-internet-access--cli-remains-in-initializing-cluster-state",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components},{TabItem:s,Tabs:t}=n;return s||h("TabItem",!0),t||h("Tabs",!0),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"first-steps-with-a-local-cluster",children:"First steps with a local cluster"})}),"\n",(0,l.jsx)(n.p,{children:"A local cluster lets you deploy and test Constellation without a cloud subscription.\nYou have two options:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Use MiniConstellation to automatically deploy a two-node cluster."}),"\n",(0,l.jsx)(n.li,{children:"For more fine-grained control, create the cluster using the QEMU provider."}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["Both options use virtualization to create a local cluster with control-plane nodes and worker nodes. They ",(0,l.jsx)(n.strong,{children:"don't"})," require hardware with Confidential VM (CVM) support. For attestation, they currently use a software-based vTPM provided by KVM/QEMU."]}),"\n",(0,l.jsx)(n.p,{children:"You need an x64 machine with a Linux OS.\nYou can use a VM, but it needs nested virtualization."}),"\n",(0,l.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Machine requirements:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"An x86-64 CPU with at least 4 cores (6 cores are recommended)"}),"\n",(0,l.jsx)(n.li,{children:"At least 4 GB RAM (6 GB are recommended)"}),"\n",(0,l.jsx)(n.li,{children:"20 GB of free disk space"}),"\n",(0,l.jsx)(n.li,{children:"Hardware virtualization enabled in the BIOS/UEFI (often referred to as Intel VT-x or AMD-V/SVM) / nested-virtualization support when using a VM"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["Software requirements:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Linux OS with ",(0,l.jsx)(n.a,{href:"https://www.linux-kvm.org/page/Main_Page",children:"KVM kernel module"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Recommended: Ubuntu 22.04 LTS"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://docs.docker.com/engine/install/",children:"Docker"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://gitlab.gnome.org/GNOME/libxslt/-/wikis/home",children:"xsltproc"})}),"\n",(0,l.jsxs)(n.li,{children:["(Optional) ",(0,l.jsx)(n.a,{href:"https://www.libvirt.org/manpages/virsh.html",children:"virsh"})," to observe and access your nodes"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"software-installation-on-ubuntu",children:"Software installation on Ubuntu"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'# install Docker\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg\necho "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null\nsudo apt update\nsudo apt install docker-ce\n# install other dependencies\nsudo apt install xsltproc\nsudo snap install kubectl --classic\n# install Constellation CLI\ncurl -LO https://github.com/edgelesssys/constellation/releases/latest/download/constellation-linux-amd64\nsudo install constellation-linux-amd64 /usr/local/bin/constellation\n# do not drop forwarded packages\nsudo iptables -P FORWARD ACCEPT\n'})}),"\n",(0,l.jsx)(n.h2,{id:"create-a-cluster",children:"Create a cluster"}),"\n",(0,l.jsxs)(t,{groupId:"csp",children:[(0,l.jsxs)(s,{value:"mini",label:"MiniConstellation",children:[(0,l.jsxs)(n.p,{children:["With the ",(0,l.jsx)(n.code,{children:"constellation mini"})," command, you can deploy and test Constellation locally. This mode is called MiniConstellation. Conceptually, MiniConstellation is similar to ",(0,l.jsx)(n.a,{href:"https://microk8s.io/",children:"MicroK8s"}),", ",(0,l.jsx)(n.a,{href:"https://k3s.io/",children:"K3s"}),", and ",(0,l.jsx)(n.a,{href:"https://minikube.sigs.k8s.io/docs/",children:"minikube"}),"."]}),(0,l.jsx)(n.admonition,{type:"caution",children:(0,l.jsxs)(n.p,{children:["MiniConstellation has specific soft- and hardware requirements such as a Linux OS running on an x86-64 CPU. Pay attention to all ",(0,l.jsx)(n.a,{href:"#prerequisites",children:"prerequisites"})," when setting up."]})}),(0,l.jsx)(n.admonition,{type:"note",children:(0,l.jsx)(n.p,{children:"Since MiniConstellation runs on your local system, cloud features such as load balancing,\nattaching persistent storage, or autoscaling aren't available."})}),(0,l.jsx)(n.p,{children:"The following creates your MiniConstellation cluster (may take up to 10 minutes to complete):"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"constellation mini up\n"})}),(0,l.jsxs)(n.p,{children:["This will configure your current directory as the ",(0,l.jsx)(n.a,{href:"/constellation/2.23/architecture/orchestration#workspaces",children:"workspace"})," for this cluster.\nAll ",(0,l.jsx)(n.code,{children:"constellation"})," commands concerning this cluster need to be issued from this directory."]})]}),(0,l.jsxs)(s,{value:"qemu",label:"QEMU",children:[(0,l.jsxs)(n.p,{children:["With the QEMU provider, you can create a local Constellation cluster as if it were in the cloud. The provider uses ",(0,l.jsx)(n.a,{href:"https://www.qemu.org/",children:"QEMU"})," to create multiple VMs for the cluster nodes, which interact with each other."]}),(0,l.jsx)(n.admonition,{type:"caution",children:(0,l.jsxs)(n.p,{children:["Constellation on QEMU has specific soft- and hardware requirements such as a Linux OS running on an x86-64 CPU. Pay attention to all ",(0,l.jsx)(n.a,{href:"#prerequisites",children:"prerequisites"})," when setting up."]})}),(0,l.jsx)(n.admonition,{type:"note",children:(0,l.jsx)(n.p,{children:"Since Constellation on QEMU runs on your local system, cloud features such as load balancing,\nattaching persistent storage, or autoscaling aren't available."})}),(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"To set up your local cluster, you need to create a configuration file for Constellation first."}),"\n"]}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"constellation config generate qemu\n"})}),(0,l.jsxs)(n.p,{children:["This creates a ",(0,l.jsx)(n.a,{href:"/constellation/2.23/workflows/config",children:"configuration file"})," for QEMU called ",(0,l.jsx)(n.code,{children:"constellation-conf.yaml"}),". After that, your current folder also becomes your ",(0,l.jsx)(n.a,{href:"/constellation/2.23/architecture/orchestration#workspaces",children:"workspace"}),". All ",(0,l.jsx)(n.code,{children:"constellation"})," commands for your cluster need to be executed from this directory."]}),(0,l.jsxs)(n.ol,{start:"2",children:["\n",(0,l.jsxs)(n.li,{children:["Now you can create your cluster and its nodes. ",(0,l.jsx)(n.code,{children:"constellation apply"})," uses the options set in ",(0,l.jsx)(n.code,{children:"constellation-conf.yaml"}),"."]}),"\n"]}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"constellation apply -y\n"})}),(0,l.jsx)(n.p,{children:"The Output should look like the following:"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell-session",children:'$ constellation apply -y\nChecking for infrastructure changes\nThe following Constellation cluster will be created:\n  3 control-plane nodes of type 2-vCPUs will be created.\n  1 worker node of type 2-vCPUs will be created.\nCreating\nCloud infrastructure created successfully.\nYour Constellation master secret was successfully written to ./constellation-mastersecret.json\nConnecting\nInitializing cluster\nInstalling Kubernetes components\nYour Constellation cluster was successfully initialized.\n\nConstellation cluster identifier  g6iMP5wRU1b7mpOz2WEISlIYSfdAhB0oNaOg6XEwKFY=\nKubernetes configuration          constellation-admin.conf\n\nYou can now connect to your cluster by executing:\n        export KUBECONFIG="$PWD/constellation-admin.conf"\n'})}),(0,l.jsxs)(n.p,{children:["The cluster's identifier will be different in your output.\nKeep ",(0,l.jsx)(n.code,{children:"constellation-mastersecret.json"})," somewhere safe.\nThis will allow you to ",(0,l.jsx)(n.a,{href:"/constellation/2.23/workflows/recovery",children:"recover your cluster"})," in case of a disaster."]}),(0,l.jsx)(n.admonition,{type:"info",children:(0,l.jsxs)(n.p,{children:["Depending on your setup, ",(0,l.jsx)(n.code,{children:"constellation apply"})," may take 10+ minutes to complete."]})}),(0,l.jsxs)(n.ol,{start:"3",children:["\n",(0,l.jsx)(n.li,{children:"Configure kubectl"}),"\n"]}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'export KUBECONFIG="$PWD/constellation-admin.conf"\n'})})]})]}),"\n",(0,l.jsx)(n.h2,{id:"connect-to-the-cluster",children:"Connect to the cluster"}),"\n",(0,l.jsx)(n.p,{children:"Your cluster initially consists of a single control-plane node:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell-session",children:"$ kubectl get nodes\nNAME              STATUS   ROLES           AGE   VERSION\ncontrol-plane-0   Ready    control-plane   66s   v1.24.6\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Additional nodes will request to join the cluster shortly. Before each additional node is allowed to join the cluster, its state is verified using remote attestation by the ",(0,l.jsx)(n.a,{href:"/constellation/2.23/architecture/microservices#joinservice",children:"JoinService"}),".\nIf verification passes successfully, the new node receives keys and certificates to join the cluster."]}),"\n",(0,l.jsx)(n.p,{children:"You can follow this process by viewing the logs of the JoinService:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell-session",children:'$ kubectl logs -n kube-system daemonsets/join-service -f\n{"level":"INFO","ts":"2022-10-14T09:32:20Z","caller":"cmd/main.go:48","msg":"Constellation Node Join Service","version":"2.1.0","cloudProvider":"qemu"}\n{"level":"INFO","ts":"2022-10-14T09:32:20Z","logger":"validator","caller":"watcher/validator.go:96","msg":"Updating expected measurements"}\n...\n'})}),"\n",(0,l.jsx)(n.p,{children:"Once all nodes have joined your cluster, it may take a couple of minutes for all resources to become available.\nYou can check on the state of your cluster by running the following:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell-session",children:"$ kubectl get nodes\nNAME              STATUS   ROLES           AGE     VERSION\ncontrol-plane-0   Ready    control-plane   2m59s   v1.24.6\nworker-0          Ready    <none>          32s     v1.24.6\n"})}),"\n",(0,l.jsx)(n.h2,{id:"deploy-a-sample-application",children:"Deploy a sample application"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["Deploy the ",(0,l.jsx)(n.a,{href:"https://github.com/BuoyantIO/emojivoto",children:"emojivoto app"})]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"kubectl apply -k github.com/BuoyantIO/emojivoto/kustomize/deployment\n"})}),"\n",(0,l.jsxs)(n.ol,{start:"2",children:["\n",(0,l.jsx)(n.li,{children:"Expose the frontend service locally"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"kubectl wait --for=condition=available --timeout=60s -n emojivoto --all deployments\nkubectl -n emojivoto port-forward svc/web-svc 8080:80 &\ncurl http://localhost:8080\nkill %1\n"})}),"\n",(0,l.jsx)(n.h2,{id:"terminate-your-cluster",children:"Terminate your cluster"}),"\n",(0,l.jsxs)(t,{groupId:"csp",children:[(0,l.jsxs)(s,{value:"mini",label:"MiniConstellation",children:[(0,l.jsx)(n.p,{children:"Once you are done, you can clean up the created resources using the following command:"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"constellation mini down\n"})}),(0,l.jsxs)(n.p,{children:["This will destroy your cluster and clean up your workspace.\nThe VM image and cluster configuration file (",(0,l.jsx)(n.code,{children:"constellation-conf.yaml"}),") will be kept and may be reused to create new clusters."]})]}),(0,l.jsxs)(s,{value:"qemu",label:"QEMU",children:[(0,l.jsx)(n.p,{children:"Once you are done, you can clean up the created resources using the following command:"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"constellation terminate\n"})}),(0,l.jsx)(n.p,{children:"This should give the following output:"}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell-session",children:"$ constellation terminate\nYou are about to terminate a Constellation cluster.\nAll of its associated resources will be DESTROYED.\nThis action is irreversible and ALL DATA WILL BE LOST.\nDo you want to continue? [y/n]:\n"})}),(0,l.jsxs)(n.p,{children:["Confirm with ",(0,l.jsx)(n.code,{children:"y"})," to terminate the cluster:"]}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell-session",children:"Terminating ...\nYour Constellation cluster was terminated successfully.\n"})}),(0,l.jsxs)(n.p,{children:["This will destroy your cluster and clean up your workspace.\nThe VM image and cluster configuration file (",(0,l.jsx)(n.code,{children:"constellation-conf.yaml"}),") will be kept and may be reused to create new clusters."]})]})]}),"\n",(0,l.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,l.jsxs)(n.p,{children:["Make sure to use the ",(0,l.jsx)(n.a,{href:"https://github.com/edgelesssys/constellation/releases/latest",children:"latest release"})," and check out the ",(0,l.jsx)(n.a,{href:"https://github.com/edgelesssys/constellation/issues?q=is%3Aopen+is%3Aissue+label%3A%22known+issue%22",children:"known issues"}),"."]}),"\n",(0,l.jsx)(n.h3,{id:"vms-have-no-internet-access--cli-remains-in-initializing-cluster-state",children:'VMs have no internet access / CLI remains in "Initializing cluster" state'}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"iptables"})," rules may prevent your VMs from accessing the internet.\nMake sure your rules aren't dropping forwarded packages."]}),"\n",(0,l.jsx)(n.p,{children:"List your rules:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"sudo iptables -S\n"})}),"\n",(0,l.jsx)(n.p,{children:"The output may look similar to the following:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell-session",children:"-P INPUT ACCEPT\n-P FORWARD DROP\n-P OUTPUT ACCEPT\n-N DOCKER\n-N DOCKER-ISOLATION-STAGE-1\n-N DOCKER-ISOLATION-STAGE-2\n-N DOCKER-USER\n"})}),"\n",(0,l.jsxs)(n.p,{children:["If your ",(0,l.jsx)(n.code,{children:"FORWARD"})," chain is set to ",(0,l.jsx)(n.code,{children:"DROP"}),", you need to update your rules:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"sudo iptables -P FORWARD ACCEPT\n"})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}function h(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);