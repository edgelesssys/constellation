name: Malicious join
description: "Verify that a malicious node cannot join a Constellation cluster."

inputs:
  cloudProvider:
    description: "The cloud provider the test runs on."
    required: true
  kubeconfig:
    description: "The kubeconfig file for the cluster."
    required: true

runs:
  using: "composite"
  steps:
    - name: Run malicious join
      shell: bash
      env:
        KUBECONFIG: ${{ inputs.kubeconfig }}
      working-directory: e2e/malicious-join
      run: |
        yq eval -i "(.spec.template.spec.containers[0].command) = [ \"/malicious-join_test\", \"--js-endpoint=join-service.kube-system:9090\", \"--csp=${{ inputs.cloudProvider }}\", \"--variant=default\" ]" job.yaml
        kubectl create ns malicious-join
        kubectl apply -n malicious-join -f job.yaml
        kubectl wait -n malicious-join --for=condition=complete --timeout=10m job/malicious-join
        LAST_TEST_LOG=$(kubectl logs -n malicious-join job/malicious-join | tail -n 1)
        LAST_JS_LOG=$(kubectl logs -n kube-system svc/join-service | tail -n 1)
        # The test passes if an error occurs when trying to join the cluster.
        if [[ "$TEST_LOGS" != *"PASS"* ]]; then
          kubectl logs -n malicious-join job/malicious-join | tee -a "$GITHUB_OUTPUT"
          exit 1
        fi
        # The last log of the join service should be an error message about the attestation document.
        if [[ "$LAST_JS_LOG" != *"Failed to validate attestation document: validating attestation public key"* ]]; then
          kubectl logs -n kube-system svc/join-service | tee -a "$GITHUB_OUTPUT"
          exit 1
        fi
        kubectl delete ns malicious-join
